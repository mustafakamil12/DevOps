async def apiRequester(
    subnet_complex,
    headers,
    client: httpx.AsyncClient,
    undef_subnets,
    undef_subnets_cidr_comp,
    semaphore,
    params=None,
):
    subnet_cidr, subnet = subnet_complex

    url = f"https://sit.b2b.cti.otservices.citigroup.net/dns/v1/subnet/{subnet}?pageSize=4094&page=1"

    logging.debug(f"semaphore: {semaphore}")

    async with semaphore:
        # Small jitter
        await asyncio.sleep(random.uniform(0.05, 0.2))

        try:
            response = await client.get(
                url,
                headers=headers,
                params=params,
            )

            await asyncio.sleep(random.uniform(0.05, 0.2))

            if response.status_code == 429:
                logging.debug(f"[{subnet}] 429 Too Many Requests.")
                # Later: implement retry/backoff logic here if needed
                return None

            if response.status_code >= 500:
                logging.debug(f"Error: [{subnet}] is undefined!")
                undef_subnets.append(subnet)
                undef_subnets_cidr_comp.append(subnet_complex)
                return None

            if response.status_code == 200:
                response_json = response.json()

                for address in response_json.get("addresses", []):
                    address["subnet_cidr"] = subnet_cidr

                return response_json.get("addresses", None)

            # For other 4xx, just log and return None
            logging.warning(f"[{subnet}] Unexpected status code: {response.status_code}")
            return None

        except httpx.HTTPError as e:
            await asyncio.sleep(random.uniform(0.05, 0.2))
            logging.error(f"[{subnet}] API request failed: {e}")
            return None


======================================

async def api_controller(
    subnets,
    headers,
    pkcs12_filename,
    pkcs12_passphrase,
    undef_subnets,
    undef_subnets_cidr_comp,
    max_concurrent,
    params=None,
):
    semaphore = asyncio.Semaphore(max_concurrent)

    # Create SSL context once
    ssl_context = create_ssl_context(pkcs12_filename, pkcs12_passphrase)

    # Create one shared AsyncClient
    async with httpx.AsyncClient(
        verify=ssl_context,
        timeout=httpx.Timeout(30.0),
        http2=True,        # if the server supports it, this can help
        limits=httpx.Limits(
            max_connections=100,          # tune based on your infra
            max_keepalive_connections=20, # keepalive pool
        ),
    ) as client:
        tasks = [
            apiRequester(
                subnet_complex=subnet,
                headers=headers,
                client=client,
                undef_subnets=undef_subnets,
                undef_subnets_cidr_comp=undef_subnets_cidr_comp,
                semaphore=semaphore,
                params=params,
            )
            for subnet in subnets
        ]

        results = await asyncio.gather(*tasks)
        results = [res for res in results if res is not None]
        return results
