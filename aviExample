# nsx_client.py
import asyncio
import httpx
from typing import Dict, Any, List, Callable, Awaitable

class NSXApiClient:
    def __init__(self, base_url: str, username: str, password: str, *, max_conn: int = 32, timeout: float = 15.0):
        self.base_url = base_url.rstrip("/")
        self.auth = (username, password)
        self.max_conn = max_conn
        self.timeout = timeout
        self._client: httpx.AsyncClient | None = None

    async def __aenter__(self):
        limits = httpx.Limits(
            max_connections=self.max_conn,
            max_keepalive_connections=self.max_conn,
        )
        self._client = httpx.AsyncClient(
            base_url=self.base_url,
            auth=self.auth,
            timeout=self.timeout,
            limits=limits,
            http2=True,
            trust_env=True,
        )
        return self

    async def __aexit__(self, exc_type, exc, tb):
        if self._client is not None:
            await self._client.aclose()
            self._client = None

    # ----- low-level request helper -----
    async def _get(self, path: str) -> Dict[str, Any]:
        assert self._client is not None, "Client not initialized (use 'async with NSXApiClient(...) as client:')"
        r = await self._client.get(path)
        r.raise_for_status()
        try:
            return r.json()
        except ValueError:
            return {"_text": r.text}

    # ----- one method per QA / URL type -----
    async def get_mgr_motd(self, node_uuid: str) -> Dict[str, Any]:
        path = f"/api/v1/cluster/{node_uuid}/motd"   # adjust to your real path
        return await self._get(path)

    async def get_mgr_dns(self, node_uuid: str) -> Dict[str, Any]:
        path = f"/api/v1/cluster/{node_uuid}/node/network/name-servers"
        return await self._get(path)

    async def get_mgr_ntp(self, node_uuid: str) -> Dict[str, Any]:
        path = f"/api/v1/cluster/{node_uuid}/node/ntp"
        return await self._get(path)

    async def get_mgr_syslog(self, node_uuid: str) -> Dict[str, Any]:
        path = f"/api/v1/cluster/{node_uuid}/node/services/syslog/exporters"
        return await self._get(path)

    async def get_mgr_tls(self, node_uuid: str) -> Dict[str, Any]:
        path = f"/api/v1/cluster/{node_uuid}/node/services/http"
        return await self._get(path)

    async def get_mgr_forwarding_mode(self, node_uuid: str) -> Dict[str, Any]:
        path = f"/api/v1/cluster/{node_uuid}/node/forwarding"
        return await self._get(path)

    async def get_mgr_search_domain(self, node_uuid: str) -> Dict[str, Any]:
        path = f"/api/v1/node/network/search-domains"
        return await self._get(path)

    async def get_mgr_backup(self, node_uuid: str) -> Dict[str, Any]:
        path = f"/api/v1/backups/config"
        return await self._get(path)

    async def get_mgr_users(self, node_uuid: str) -> Dict[str, Any]:
        path = f"/api/v1/aaa/role-bindings"
        return await self._get(path)

    # Mapping from QA names to the corresponding methods
    def _qa_dispatch(self) -> Dict[str, Callable[[str], Awaitable[Dict[str, Any]]]]:
        return {
            "get_mgr_motd":            self.get_mgr_motd,
            "get_mgr_dns":             self.get_mgr_dns,
            "get_mgr_ntp":             self.get_mgr_ntp,
            "get_mgr_syslog":          self.get_mgr_syslog,
            "get_mgr_tls":             self.get_mgr_tls,
            "get_mgr_forwarding_mode": self.get_mgr_forwarding_mode,
            "get_mgr_search_domain":   self.get_mgr_search_domain,
            "get_mgr_backup":          self.get_mgr_backup,
            "get_mgr_users":           self.get_mgr_users,
        }

    # ----- this is your "fetch_all" as a method -----
    async def fetch_all_for_node(self, node_uuid: str, qa_list: List[str]) -> Dict[str, Dict[str, Any]]:
        """
        Run all requested QA methods for a single node concurrently.
        Returns: {qa_name: payload_dict}
        """
        dispatch = self._qa_dispatch()

        async def run_one(qa_name: str):
            func = dispatch.get(qa_name)
            if func is None:
                return qa_name, {"_error": f"unknown_qa: {qa_name}"}
            try:
                res = await func(node_uuid)
                return qa_name, res
            except Exception as e:
                return qa_name, {"_error": f"{type(e).__name__}: {e}"}

        coros = [run_one(q) for q in qa_list]
        results = await asyncio.gather(*coros, return_exceptions=False)
        return {qa_name: payload for qa_name, payload in results}
=================================================================================================
call from main app

# orchestrator.py
import asyncio
from nsx_client import NSXApiClient

qa_list = [
    "get_mgr_motd",
    "get_mgr_dns",
    "get_mgr_ntp",
    "get_mgr_syslog",
    "get_mgr_tls",
    "get_mgr_forwarding_mode",
    "get_mgr_search_domain",
    "get_mgr_backup",
    "get_mgr_users",
]

async def run_all_nodes(index_uuid):
    """
    index_uuid: list of (vip, index, node_uuid)
    """
    # If all nodes share one manager VIP:
    vip = "https://apvogsnsxmgm.apac.nsxroot.net"  # example; or derive from data
    username = "nsx_user"
    password = "nsx_pass"

    async with NSXApiClient(vip, username, password, max_conn=32) as client:
        async def process_one(entry):
            fqdn, idx, node_uuid = entry
            qa_results = await client.fetch_all_for_node(node_uuid, qa_list)
            # you can now merge qa_results into your df or return them
            return fqdn, idx, node_uuid, qa_results

        tasks = [process_one(t) for t in index_uuid]
        return await asyncio.gather(*tasks, return_exceptions=False)

async def main():
    index_uuid = [
        ("apchkxanstxsm00p.apac.nsxroot.net", 0, "e87e38d2-f1a4-fede-660b-c50d7d2c1d5b"),
        # ...
    ]
    results = await run_all_nodes(index_uuid)
    for fqdn, idx, node_uuid, qa_results in results:
        print(f"Node={fqdn} idx={idx} uuid={node_uuid}")
        for qa, payload in qa_results.items():
            print("  ", qa, "=>", payload)

if __name__ == "__main__":
    asyncio.run(main())

========================================
async with NSXApiClient(base_url, user, pwd) as client:
    qa_results = await client.fetch_all_for_node(node_uuid, qa_list)

========================================

await client.get_mgr_dns(node_uuid)
await client.get_mgr_ntp(node_uuid)
...
