import asyncio, inspect

async def run_checks_for_all_nodes(rows, max_concurrency: int = 32):
    sem = asyncio.Semaphore(max_concurrency)

    async def run_one(node, uuid, qa_name, api_path):
        if not api_path:
            return (node, qa_name, {"_error": "no_api_path"})
        if "{node_uuid}" in api_path:
            api_path = api_path.format(node_uuid=uuid)

        mgr_configs = s.NsxManagerConfigs(vip=node, api_path=api_path)
        func = getattr(mgr_configs, qa_name, None)
        if func is None:
            return (node, qa_name, {"_error": f"method_not_found: {qa_name}"})

        async with sem:
            try:
                if inspect.iscoroutinefunction(func):
                    return (node, qa_name, await func())
                else:
                    return (node, qa_name, await asyncio.to_thread(func))
            except Exception as e:
                return (node, qa_name, {"_error": f"{type(e).__name__}: {e}"})

    tasks = []
    for node, uuid, pairs in rows:
        for qa_name, api_path in pairs:
            tasks.append(asyncio.create_task(run_one(node, uuid, qa_name, api_path)))

    return await asyncio.gather(*tasks, return_exceptions=False)
